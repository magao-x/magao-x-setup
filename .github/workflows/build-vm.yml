name: Build virtual machine (ARM)
on:
  workflow_dispatch: # Manual trigger only
  # TODO: Re-enable workflow_run trigger after container build is working
  # workflow_run:
  #   workflows: ["Container build"]
  #   types: [completed]
  #   branches: [main]
  # push:
  #   branches: [main]
defaults:
  run:
    working-directory: xvm/
jobs:
  build-vm-stage1:
    # TODO: Re-enable this condition when using workflow_run trigger
    # if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-24.04-arm
    env:
      vmArch: aarch64
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Cache first stage VM
        uses: actions/cache@v4
        id: cache-vm-stage1
        with:
          path: xvm/stage1_outputs.tar.zst
          key: xvm-stage1-${{ env.vmArch }}-${{ hashFiles('xvm/_common.sh','xvm/build_vm_stage0.sh','xvm/create_kickstart.sh','xvm/kickstart/ks.cfg.template','xvm/create_rocky_iso.sh','xvm/build_vm_stage1.sh','xvm/download_firmware.sh','xvm/guest_setup_users_and_groups.sh','xvm/guest_shutdown.sh','setup_users_and_groups.sh','_common.sh') }}-v1
      - name: Install VM build dependencies
        if: steps.cache-vm-stage1.outputs.cache-hit != 'true'
        run: sudo apt-get update -y && sudo apt-get install -y qemu-system-arm zstd
      - name: Generate VM SSH key and unattended install disk
        if: steps.cache-vm-stage1.outputs.cache-hit != 'true'
        run: bash build_vm_stage0.sh

      - name: Generate VM SSH key and unattended install disk
        if: steps.cache-vm-stage1.outputs.cache-hit != 'true'
        run: bash build_vm_stage0.sh


      - name: Create VM and install Rocky 9
        if: steps.cache-vm-stage1.outputs.cache-hit != 'true'
        run: bash build_vm_stage1.sh
      - name: Bundle outputs as tar file
        if: steps.cache-vm-stage1.outputs.cache-hit != 'true'
        run: |
            rm ./output/*.iso
            tar -I 'zstd -9 -T0' -cvf stage1_outputs.tar.zst ./output/
            rm ./output/*
      - name: Upload stage 1 outputs
        uses: actions/upload-artifact@v4
        with:
          retention-days: 1
          name: stage1_vm
          path: xvm/stage1_outputs.tar.zst
  build-vm-stage2:
    # if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-24.04-arm
    env:
      vmArch: aarch64
    needs: build-vm-stage1
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install VM build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-arm zstd
      - name: Download initial Rocky VM
        uses: actions/download-artifact@v4
        with:
            name: stage1_vm
            path: xvm/
      - name: Extract previous job outputs
        run: |
            tar -xvf stage1_outputs.tar.zst
            rm stage1_outputs.tar.zst
            mv -v output/xvm_stage1.qcow2 output/xvm.qcow2
      - name: Install MagAO-X software
        run: bash build_vm_stage2.sh
      - name: Bundle outputs as tar file
        run: tar -I 'zstd -9 -T0' -cvf stage2_outputs.tar.zst ./output/xvm_stage2.qcow2 ./output/xvm_key ./output/xvm_key.pub ./output/firmware_vars.fd ./output/firmware_code.fd
      - name: Upload stage 2 outputs
        uses: actions/upload-artifact@v4
        with:
          name: stage2_vm
          path: xvm/stage2_outputs.tar.zst
  build-vm-stage3:
      # if: ${{ github.event.workflow_run.conclusion == 'success' }}
      runs-on: ubuntu-24.04-arm
      env:
        vmArch: aarch64
      needs: build-vm-stage2
      permissions:
        contents: read
        packages: write
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
        - name: Install VM build dependencies
          run: sudo apt-get update && sudo apt-get install -y qemu-system-arm zstd
        - name: Download initial Rocky VM
          uses: actions/download-artifact@v4
          with:
              name: stage2_vm
              path: xvm/
        - name: Extract previous job outputs
          run: |
              tar -xvf stage2_outputs.tar.zst
              rm stage2_outputs.tar.zst
              mv -v output/xvm_stage2.qcow2 output/xvm.qcow2
        - name: Install MagAO-X software
          run:  bash build_vm_stage3.sh
        - name: Bundle outputs as tar file
          run: tar -I 'zstd -9 -T0' -cvf stage3_outputs.tar.zst ./output/xvm_stage3.qcow2 ./output/xvm_key ./output/xvm_key.pub ./output/firmware_vars.fd ./output/firmware_code.fd
        - name: Upload stage 3 outputs
          uses: actions/upload-artifact@v4
          with:
            name: stage3_vm
            path: xvm/stage3_outputs.tar.zst
  build-vm-stage4:
    # if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-24.04-arm
    env:
      vmArch: aarch64
    needs: build-vm-stage3
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install VM build dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-arm zstd xz-utils
      - name: Download Rocky VM with dependencies
        uses: actions/download-artifact@v4
        with:
            name: stage3_vm
            path: xvm/
      - name: Extract previous job outputs
        run: |
            tar -xvf stage3_outputs.tar.zst
            rm stage3_outputs.tar.zst
            mv -v output/xvm_stage3.qcow2 output/xvm.qcow2
      - name: Install MagAO-X software
        run: bash build_vm_stage4.sh
      - name: Upload virtual machine for UTM
        uses: actions/upload-artifact@v4
        with:
          name: vm_${{ env.vmArch }}
          path: xvm/output/bundle/
          if-no-files-found: error
          compression-level: 9
